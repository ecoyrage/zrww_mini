<style lang="less">
.zrww{
  width: 692rpx;
  height: 300rpx;
  line-height: 20px;
  border-radius: 5px;
  text-align: left;
  box-shadow: 0px 0px 0px 0px rgba(170, 170, 170, 1);
  border: 1px solid rgba(51, 51, 51, 1);
  background-color: #fff;

}
.userinfo-avatar {
  width: 80rpx;
  height: 80rpx;
  margin-left:20rpx;
}
.userinfo-avatar image{
  width: 80rpx;
  height:80rpx;
  border-radius: 50%;
}
.zrww_logo{
   width: 150rpx;
   height:38rpx;
   position:absolute;
   margin-top:-80rpx;
   left:130rpx;
  
}
.zrww_logo image{
   width: 150rpx;
   height:38rpx;
   
}
.zrww_logo text{
  color: rgba(153, 153, 153, 1);
  font-size: 12px;
  display: block;
}
.login{
  display: flex;
  align-items: center;
  justify-content: center; 
  width: 670rpx;
  height: 100rpx;
  line-height: 20px;
  border-radius: 5px;
  color: #ffffff;
  font-size: 32rpx;
}
.login-wechat{
  margin-top:40rpx;
  background-color: #5383c3;
  color: #ffffff;
}
.grey_space{
   background-color: #F6F6F6;
   height: 10rpx;
}
.search_img{
  width: 46rpx;
  height: 46rpx;
}
.Title{
  display: flex;
  align-items: center;
}
.title2{
  margin-left:20rpx;
  // margin-top:20rpx;
  font-size: 14px;
  color:#999;
}

.behave2{
  margin-top:20rpx;
  margin-right:20rpx;
  // line-height:-16rpx;
  // float:right;
  width:170rpx;
  height: 60rpx;
  line-height: 60rpx;
  background-color: #F6F6F6;
  color:#5383c3;
  font-size: 14px;
  border-radius: 5px;
}
.blue_text{
 color:#5383C3;
}
.question_info{
  float: left;
  margin-top:10rpx;
}
.nick_name{
  margin-left:20rpx;
  color: rgba(51, 51, 51, 1);
  font-size: 14px;
}
.question_status{
  margin-left:20rpx;
  color: #5383C3;
  font-size: 14px;
}

.end_time{
  margin-left:20rpx;
  color: rgba(153, 153, 153, 1);
  font-size: 10px;
}
.questionDescribe{
  margin-left:20rpx;
  color: rgba(153, 153, 153, 1);
  font-size: 10px;
}
.chakan{
    width:134rpx;
    height: 60rpx;
    border-radius: 5px;
    background-color: rgba(83, 131, 195, 1);
    color: rgba(255, 255, 255, 1);
    font-size: 14px;
    line-height: 60rpx;
}
.lxwm_img{
  width:48rpx;
  height: 48rpx;
  position:absolute;
  right:40rpx;
  top:0rpx;
}
.search_img{
  width:48rpx;
  height: 48rpx;
  position:absolute;
  right:120rpx;
  top:0rpx;
}
.roollingtitle{
  font-size:14px;
  color:#999;
  margin:22rpx 0;
}
</style>
<template>
  <view>
    <view style="background-color: #F6F6F6">
     <view class="userinfo-avatar" @tap="userInfo()">
          <image  src="{{avatarUrl}}"></image>
      </view>
      <view class="zrww_logo">
          <image  src="../../files/img/zrww.png"></image>
          <text>{{district}}</text>
      </view>
      <view>
       <image class="lxwm_img" @tap="connectUs()" src="../../files/img/lxwm.png"></image>
        <image class="search_img" @tap="search()" src="../../files/img/search_black.png"></image>
      </view>
      <view style="display:flex;align-items:center;justify-content:center;height: 380rpx;">
        <view class="zrww" @tap="zrww()">
          <view style="color:#333;font-size:18px;font-weight:bold;margin:20rpx 20rpx;">输入想找的人  ·  想问的事</view>
          <view style="color:#999;font-size:14px;margin:100rpx 20rpx;">{{questionCaseList}}</view>   
        </view>
      </view>
    </view>
  
    <view wx:if="{{upperQuestionList.length<=0}}">

        <swiper  autoplay="{{autoplay}}" interval="5000"  duration="1000" circular="true" style="height:200rpx;">
            <repeat for="{{rollingdata}}" item="item">
              <swiper-item>
                <view wx:if="{{item.jumpType==-1}}" style="text-align: center;"> 
                  <swiper  autoplay="true" interval="3000" vertical="true" duration="1000" circular="true" style="height:200rpx;">
                        <swiper-item>
                          <repeat for="{{item.data}}" item="swiperText" index="index">
                            <view wx:if="{{index/3<1}}" class="roollingtitle">{{swiperText[0]}}<text class="blue_text">{{swiperText[1]}}</text>{{swiperText[2]}}</view>
                         </repeat>
                        </swiper-item>
                         <swiper-item>
                          <repeat for="{{item.data}}" item="swiperText" index="index">
                            <view wx:if="{{index/3>=1&&index/3<2}}" class="roollingtitle">{{swiperText[0]}}<text class="blue_text">{{swiperText[1]}}</text>{{swiperText[2]}}</view>
                         </repeat>
                        </swiper-item>
                  </swiper>
                </view>
                <view wx:elif="{{item.jumpType==5}}" @tap="toOutHtml({{item.jumpTarget}})"> 
                  <image src="{{item.fileUrl}}"  mode="widthFix" style="width: 100%;"/>
                </view>
                <view wx:elif="{{item.jumpType==8}}" @tap="toAnswererIntroduce({{item.jumpTarget}})"> 
                  <image src="{{item.fileUrl}}"  mode="widthFix" style="width: 100%;"/>
                </view>
                 <view wx:elif="{{item.jumpType==9}}"> 
                   <video src="{{item.jumpTarget}}" @play="changeAutoplay()" @pause="ended()" @ended="ended()" style="width:100%;height:200rpx;"  poster="{{item.fileUrl}}" controls show-fullscreen-btn></video>
                </view>
             
              </swiper-item>
            </repeat>
        </swiper>
        <view class="grey_space"></view>

       

        <view wx:if="{{timePass5}}">
          <view wx:if="{{info.responderStatus!=1}}">
            <view class="Title" >
              <view class="title2">自身价值<text class="blue_text">变现</text></view>
               <button class="behave2" @tap="toBeResponder()">成为答者</button>
              </view>
            <view class='line' style="margin-top:10rpx;"></view>
          </view>
          <view class="Title">
            <view class="title2">一次邀请，<text class="blue_text">永久</text>收益</view>
            <button class="behave2" @tap="toInviteFriends()">去了解</button>
          </view>
          <view class="grey_space" style="margin-top:10rpx;"></view>
      </view>


      <view wx:if="{{!timePass5}}">
          <view wx:if="{{info.responderStatus!=1}}">
            <indexArea>
                <image class="icon" src="{{be_responder}}" slot="icon"></image>
                <view class="title" slot="title">成为服务者、价值变现</view>
                <view class="subtitle" slot="subtitle">希望你也可以成为服务者，服务他人的同时让自身更有价值。</view>
            </indexArea>
          </view>
       <view class="grey_space" style="margin-top:80rpx;height:5rpx;"></view>
          <indexArea>
            <image class="icon" src="{{go_invite}}" slot="icon"></image>
            <view class="title" slot="title">一次邀请、永久收益</view>
            <view class="subtitle" slot="subtitle">邀请朋友加入我们，让他们的价值得到发挥，让我们也可以给他们提供帮助</view>
          </indexArea>
      </view>
     <view class="grey_space" style="margin-top:80rpx;"></view>
     </view>



     <view wx:if="{{upperQuestionList.length>0}}">
        <!--upperQuestionList.questionList start  -->
        <!-- <view class="grey_space" style="margin-top:40rpx;"></view> -->
        <repeat for="{{upperQuestionList}}" item="item">
            <view wx:if="{{item.status==1||item.status==2||item.status==6||item.status==7}}" @tap="viewQuestion({{item.questionId}})">
              <view class="question_avatar">
                    <image src="{{item.avatarUrl==''?'../../files/img/avatarUrl.png':item.avatarUrl}}"></image>
              </view>
              <view class="question_info">
                <text class="nick_name">{{item.responderShowName}}</text>
                <text class="question_status" style="{{item.status==2||item.status==6||item.status==7?'color:#DF7163':''}}">{{status[item.status]}}</text>
                <view style="clear:both"></view>
                <view wx:if="{{item.status==2}}">
                  <text class="end_time">{{item.createTime}}</text>
                </view>
                <view wx:else>
                  <text class="end_time"></text>  
                </view>
                <view style="clear:both"></view>
                <text class="questionDescribe">简述：{{item.questionDescribe}}</text>
              </view>
              <view style="clear:both"></view>
            </view>

            <view wx:else>
              <view class="question_avatar">
                    <image src="{{item.avatarUrl==''?'../../files/img/avatarUrl.png':item.avatarUrl}}"></image>
              </view>
              <view class="question_info">
                <text class="nick_name">{{item.responderShowName}}</text>
                <text class="question_status" style="{{item.status==6?'color:#DF7163':''}}">{{status[item.status]}}<text wx:if="{{item.status==3&&item.recommendNumber>0}}">,已收到{{item.recommendNumber}}个推荐</text></text>
                <view style="clear:both"></view>
                <view wx:if="{{item.status==3}}">
                  <text class="end_time">剩余：{{item.countDown.day}}天{{item.countDown.hou}}时{{item.countDown.min}}分{{item.countDown.sec}}秒</text>  
                </view>
                <view wx:else>
                  <text class="end_time"></text>  
                </view>
                <view style="clear:both"></view>
                <text class="questionDescribe">简述：{{item.questionDescribe}}</text>
              </view>
              <view style="display:inline-table;position:absolute;right:20rpx;margin-top:40rpx;">
                  <button class="chakan" >查看</button>
              </view>
              <view style="clear:both"></view>
            </view>
            


        </repeat>

      <view class="grey_space" style="margin-top:40rpx;"></view>
      <view >
        <view style="height:100rpx;">
          <view style="padding-top:40rpx;margin-left:20rpx;color:#999;font-size:12px;">已回答<text class="blue_text">{{info.answerNumber}}个</text>问题，共赚<text class="blue_text">{{info.answerBalance}}元</text></view>
          <!-- <image class="icon_qianjin" style="margin-top:-40rpx;" src="../../files/img/qianjin.png"></image> -->
        </view>
        <view class='line' style="margin-top:10rpx;"></view>
        <view style="height:100rpx;" @tap="toInviteeList()">
          <view style="padding-top:40rpx;margin-left:20rpx;color:#999;font-size:12px;">已邀请<text class="blue_text">{{info.invitationNumber}}位</text>好友，共有<text class="blue_text">{{info.contacts}}人脉</text>，累计奖励<text class="blue_text" >{{info.invitationBalance}}元</text></view>
          <image class="icon_qianjin" style="margin-top:-40rpx;" src="../../files/img/qianjin.png"></image>
        </view>
       
      </view>
      <view class="grey_space" style="margin-top:10rpx;"></view>
      <!--upperQuestionList.questionList end  -->
     </view>

    <questionList :questionList.sync="questionList" :questionReward.sync="questionReward"></questionList>


    
    
    
  </view>
</template>

<script>
  import wepy from 'wepy'
  import indexArea from '@/components/index_area' 
  import utils from "@/mixins/utils"
  import questionList from '@/components/question_list'
  import Panel from '@/components/panel' 

  export default class index extends wepy.page {
    config = {
      navigationBarTitleText: '',
      enablePullDownRefresh: true,
      navigationBarBackgroundColor: "#F6F6F6",
    }
    components = {
      indexArea:indexArea,
      questionList:questionList,
      panel: Panel,
    }

    data = {
      avatarUrl:"../../files/img/avatarUrl.png",
      go_invite:"../../files/img/go_invite.png",
      be_responder:"../../files/img/be_responder.png",
      isLogin:'',
      questionList:[
      ],
      upperQuestionList:[],
      timePass5:false,
      status:[
        '待支付',
        '审核中',
        '审核驳回',
        '发布中',
        '等待接单',
        '接单超时',
        '取消订单',
        '拒绝',
        '交流中',
        '退款',
        '待评价',
        '交易结束'
      ],
      questionReward:'',
      info:'',
      pageNum:1,
      pageSize:10,
      noMore:'',
      district:'',
      rollingdata:[
      ],
      autoplay:true,
      questionCaseList:''
       
    }
   


    mixins=[utils]

    methods = {
      changeAutoplay(){
        this.autoplay=false;
        this.$apply();
      },
      ended(){
        this.autoplay=true;
        this.$apply();
      },
      userInfo(){
        if(!this.isLogin){
          wepy.navigateTo({
            url:'/pages/login/login'
          })
        }else{
           wepy.navigateTo({
            url:'/pages/basicInfo/basic_info'
          })
        }
      
      },
      toInviteFriends(){
        let self=this;
        if(!this.isLogin){
          wepy.navigateTo({
            url:'/pages/login/login'
          })
        }else{
          wepy.navigateTo({
            url:'/pages/invite_friends?invitationCode='+  wx.getStorageSync('basicInfo').invitationCode
          })
        }
      },
      toBeResponder(){
        if(!this.isLogin){
          wepy.navigateTo({
            url:'/pages/login/login'
          })
        }else{
          wepy.navigateTo({
            url:'/pages/be_responder'
          })
        }
      },
      toInviteeList(){
         wepy.navigateTo({ 
            url: '/pages/wallet/invitee_list' 
        });
         
     },
      zrww(){
          wepy.navigateTo({
            url:'/pages/zrww/zrww'
          })
      },
      connectUs(){
        wepy.navigateTo({
            url:'/pages/index/connectUs'
        })
      },
      toAnswererIntroduce(responderId){
         if(!this.isLogin){
          wepy.navigateTo({
            url:'/pages/login/login'
          })
        }else{
          wepy.navigateTo({
              url:'/pages/answerer_introduce?responderId='+responderId
          })
        }
      },
      toOutHtml(html){
          wepy.navigateTo({
            url:'/pages/out/privacyProtection?html='+html
          })
      },
      search(){
        wepy.navigateTo({ 
          url: '/pages/zrww/category_search' 
        });
      },
      viewQuestion(questionId){
           wepy.navigateTo({
            url: '/pages/index/question_detail?questionId='+questionId+'&showQuestionOnly=true'
          })
        }
    }


    openApp(){
       wepy.navigateTo({
          url:'/pages/login/login'
        })
    }

    onPullDownRefresh(){
        this.pageNum=1;
        this.noMore=false;
        this.onLoad();
        wx.hideNavigationBarLoading();
        wx.stopPullDownRefresh();
    }
    onReachBottom(){
        if(!this.noMore){
            let self=this;
            wx.showLoading({
              title: '玩命加载中',
            })
            let json={};
            self.pageNum+=1;
            json.pageNum=self.pageNum+'';
            json.pageSize=self.pageSize+'';
            json.firstCategoryId=self.firstCategoryId
            json.secondCategoryId=self.secondCategoryId
            let obj=self.genObj(json);
            let sign=self.genSign(obj);
            wepy.request({
              url:  self.domain+'/ww/api/v1/common/questionList',
              method: 'post',
              data: {object:obj,sign:sign},
              header:{
                'JWT': 'true',
                'content-type':'application/json', 
                'Authorization':'Bearer '+self.accessToken
              },
              success: res => {
                if(res.data.code==100){
                  wx.hideLoading();
                  let list=res.data.data.list;
                  if(list.length==0){
                    wx.showToast({
                      title: '暂无更多数据',
                      icon: 'none',
                    })
                    self.noMore=true
                  }
                  for(let i=0;i<list.length;i++){
                    if(list[i].pics==""){
                      list[i].pics="";
                    }else{
                      list[i].pics=list[i].pics.split(",");
                    }
                    self.questionList.push(list[i]);
                  }
                  self.$apply();
                }
              
              }
            })
          }else{
            wx.showToast({
                title: '暂无更多数据',
                icon: 'none',
              })
          }
    }
    
   


    events = {
      // 'index-emit': (...args) => {
      //   let $event = args[args.length - 1]
      //   console.log(`${this.$name} receive ${$event.name} from ${$event.source.$name}`)
      // }
    }
 

    getQuestionList(){
          let self=this;
          let json={};
          json.pageNum=self.pageNum+'';
          json.pageSize=self.pageSize+'';
          let obj=self.genObj(json);
          let sign=self.genSign(obj);
          wepy.request({
            url:  self.domain+'/ww/api/v1/common/questionList',
            method: 'post',
            data: {object:obj,sign:sign},
            header:{
              'JWT': 'true',
              'content-type':'application/json',
              'Authorization':'Bearer '+self.accessToken
            },
            success: res => {
              if(res.data.code==100){
                let list=res.data.data.list
                let rollingInforsList=res.data.data.rollingInforsList
                let advList=res.data.data.advList
                let rollingInfors={};
                rollingInforsList.forEach((data,index)=>{
                  rollingInforsList[index]=data.replace("<",",").replace(">",",").split(",");
                })
                rollingInfors.jumpType=-1;
                rollingInfors.data=rollingInforsList;
                self.rollingdata=[];
                self.rollingdata.push(rollingInfors);
                advList.forEach(adv=>{
                   self.rollingdata.push(adv);
                })
                self.questionList=list;
                for(let i=0;i<self.questionList.length;i++){
                  if(self.questionList[i].pics==""){
                    self.questionList[i].pics="";
                  }else{
                    self.questionList[i].pics=self.questionList[i].pics.split(",");
                  }
                }
                wx.hideNavigationBarLoading();
                wx.stopPullDownRefresh();
                self.$apply();
              }
            }

       })
    }

  timeFormat(param){//小于10的格式化函数
      return param < 10 ? '0' + param : param; 
    }

  countDown(upperQuestionList){//倒计时函数
    let self=this;
    var timer=setInterval(function () {
      let newTime = new Date().getTime();
      upperQuestionList.forEach(o => {
        let endTime = new Date(o.endTime).getTime();
        let obj = null;
        // 如果活动未结束，对时间进行处理
        if (endTime - newTime > 0){
          let time = (endTime - newTime) / 1000;
          // 获取天、时、分、秒
          let day = parseInt(time / (60 * 60 * 24));
          let hou = parseInt(time % (60 * 60 * 24) / 3600);
          let min = parseInt(time % (60 * 60 * 24) % 3600 / 60);
          let sec = parseInt(time % (60 * 60 * 24) % 3600 % 60);
          obj = {
            day: self.timeFormat(day),
            hou: self.timeFormat(hou),
            min: self.timeFormat(min),
            sec: self.timeFormat(sec)
          }
        }else{//活动已结束，全部设置为'00'
          obj = {
              day: '00',
              hou: '00',
              min: '00',
              sec: '00'
            }
          }
        o.countDown=obj
      })
      self.$apply();
    }, 1000)

    }
    onLoad() {
      let self = this
      let isLogin=wx.getStorageSync('isLogin');
      self.isLogin=isLogin;
      self.district=self.$parent.globalData.district;
      if(isLogin){
        let avatarUrl=wx.getStorageSync('basicInfo').avatarUrl;
        if(avatarUrl==""){
          avatarUrl="../../files/img/avatarUrl.png"
        }
        self.avatarUrl=avatarUrl;
      }
      let questionCaseList=wx.getStorageSync('questionCaseList');
      if(questionCaseList!=""){
        let random=Math.floor(Math.random()*questionCaseList.length)
        self.questionCaseList=questionCaseList[random].fileName;
      }
    
      self.$apply();

      let json={};
      let obj=self.genObj(json);
      let sign=self.genSign(obj);
      if(self.accessToken!=""){
        wepy.request({
          url:  self.domain+'/ww/api/v1/index/info',
          method: 'post',
          data: {object:obj,sign:sign},
          header:{
            'JWT': 'true',
            'content-type':'application/json',
            'Authorization':'Bearer '+self.accessToken
          },
          success: res => {
            if(res.data.code==100){
              let data=res.data.data;
              let createTime=data.createTime;
              
              let date1 = new Date(createTime);
              let date2 = new Date();
              let s1 = date1.getTime(),s2 = date2.getTime();
              let total = (s2 - s1)/1000;
              let day = parseInt(total / (24*60*60));//计算整数天数
              if(day>5){
                self.timePass5=true;
                self.$apply();
              }
              self.info=data;
              // if(self.avatarUrl=="../../files/img/avatarUrl.png"&&data.avatarUrl!=""){
              //   self.avatarUrl=data.avatarUrl;
              // }
              self.upperQuestionList=data.questionList;
              self.countDown(self.upperQuestionList);
              self.questionReward=self.getRealityNum(data.questionReward);
              self.info.invitationBalance=self.getRealityNum(data.invitationBalance);
              self.info.answerBalance=self.getRealityNum(data.answerBalance);
              self.$apply();
            }
          }
        });
      }

    this.getQuestionList();

      
    }
  }
</script>